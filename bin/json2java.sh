#!/bin/bash
#
# generate java source from examples of json
#
# classes will first go under a staged directory, commmented and then checked
# against existing sources.
#

# exit on any errors
set -e

PREAMBLE="
// THIS FILE WAS GENERATED BY JSON2JAVA
// IT HAS NOT BEEN CHANGED. (IF IT HAS REMOVE THIS LINE)
// CHANGES MADE:
//   * NONE SO FAR
"

BASEDIR=$(dirname $(readlink -f "$0"))

DESTDIR=server/src/main/java
if [ $# -ne 1 ]
then
    echo "USAGE: $0 filename"
    echo "   file must contain valid JSON."
    echo "   the name of the generated class will be based on filename."
    exit 1
fi

if [ ! -f "$1" ]
then
    echo "$1 is not a file"
    exit 2
fi

if [ -e staged ]
then
    echo "$PWD/staged already exists"
    exit 2
fi

mkdir staged

java -jar "$BASEDIR/jsonschema2pojo-fat-1.2.1.jar" -s "$1" -t staged -T JSON -tv 1.17 -c -dg -ds -p edu.sjsu.moth.generated

echo generated java files

# add preamble to generated files
for f in $(find staged -type f -print)
do
    cat - $f <<< "$PREAMBLE" > staged/new.tmp
    mv staged/new.tmp $f
done

echo preamble added

CHANGESPRESENT=0
# check for changes
for f in $(find staged -type f -print)
do
    OTHERDIR="$BASEDIR/../$DESTDIR/${f#staged/}"
    if [ -f "$OTHERDIR" ]
    then
        if diff -u "$OTHERDIR" "$f" 
        then
            true # this doesn't do anything bue we can't have an empty then
        else
            CHANGESPRESENT=1
        fi
    fi
done

if [ $CHANGESPRESENT == 1 ]
then
    echo "files look like the have changed. make sure you examine the diff before moving"
    echo "(you may need to move the files to $DESTDIR by hand.)"
else
    echo "files can safely be moved"
fi

echo "move generated files in staging to $DESTDIR? [y/n]"
read rsp

if [ $rsp == "Y" -o $rsp == "y" ]
then
    for f in $(find staged -type f -print)
    do
        DST="$BASEDIR/../$DESTDIR/${f#staged/}"
        mkdir -p "$(dirname $DST)"
        mv "$f" "$DST"
    done
    rm -r staged
    echo files moved
else
    echo files left in staged
fi
